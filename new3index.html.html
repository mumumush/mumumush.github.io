<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>聽力健康心理測驗</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: linear-gradient(135deg, #ffcce6, #ccf2ff, #e6ffcc, #ffcccc);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      position: relative;
    }
    h1, h2, h3 {
      text-align: left;
      color: #333;
      margin-bottom: 12px;
      font-weight: bold;
    }
    .question {
      margin: 20px 0;
    }
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .option {
      background: #fff;
      border: 2px solid #6bcb77;
      border-radius: 10px;
      padding: 10px 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .option:hover {
      background: #6bcb77;
      color: #fff;
    }
    .option.selected {
      background: #6bcb77;
      color: #fff;
    }
    .slider-container {
      width: 100%;
      margin: 20px 0;
    }
    .slider {
      width: 100%;
    }
    .slider-value {
      text-align: center;
      font-size: 18px;
      margin: 10px 0;
    }
    .btn {
      background: #b39ddb;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #9575cd;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .result-item {
      background: #fff;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      text-align: left;
    }
    .result-img {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 0;
      min-height: 150px;
    }
    .result-img img {
      width: 150px;
      height: 150px;
      display: block;
      margin: 0 auto;
    }
    .result-img-label {
      font-weight: bold;
      font-size: 20px;
      margin-top: 12px;
      text-align: center;
      letter-spacing: 1px;
    }
    .result-footer {
      width: 100%;
      background: #f6f6f6;
      border-radius: 15px;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
      position: relative;
      box-sizing: border-box;
    }
    .result-footer-hr {
      width: 100%;
      margin: 30px 0 10px 0;
      border: 0;
      border-top: 2px solid #eee;
      box-sizing: border-box;
    }
    .result-section-title {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .result-section-title span.emoji {
      margin-left: 6px;
      font-size: 20px;
    }
    ul.bullet-list {
      list-style-type: circle;
      padding-left: 20px;
      margin: 0 0 8px 0;
      text-align: left;
    }
    @media (max-width: 500px) {
      .container {
        width: 95%;
        padding: 15px;
      }
      .result-img img {
        width: 110px;
        height: 110px;
      }
      .result-img {
        min-height: 110px;
      }
      .result-img-label {
        font-size: 16px;
      }
    }
    .cave-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.3;
      background: radial-gradient(circle, #ffcce6, #ccf2ff, #e6ffcc, #ffcccc);
      background-size: cover;
      background-position: center;
      transition: background-image 0.5s;
    }
    .cave-bg.start {
      background-image: url("img/start_bg.jpg");
    }
    .cave-bg.tinnitus {
      background-image: url("img/tinnitus_bg.jpg");
    }
    .cave-bg.sleep {
      background-image: url("img/sleep_bg.jpg");
    }
    .cave-bg.dizzy {
      background-image: url("img/dizzy_bg.jpg");
    }
  </style>
</head>
<body>
  <div class="cave-bg start"></div>
  <div class="container">
    <div id="content"><!-- 內容會動態載入 --></div>
  </div>
  <script>
    // 題目資料
    const questions = [
      {
        // 0: 姓名年齡
        type: "start",
        title: "歡迎來到聽力健康心理測驗",
        inputs: [
          { id: "name", label: "您的姓名", type: "text", required: true },
          { id: "age", label: "您的年齡", type: "number", required: true },
        ],
      },
      {
        // 1: 耳鳴1
        type: "radio",
        id: "tinnitus1",
        title: "請問你有耳鳴嗎（耳朵裡面會嘰嘰叫或轟轟叫）？",
        options: [
          { label: "有", value: "yes" },
          { label: "沒有", value: "no" },
        ],
      },
      {
        // 2: 耳鳴2
        type: "radio",
        id: "tinnitus2",
        title: "耳鳴的頻率？",
        options: [
          { label: "每天", value: "daily" },
          { label: "一週超過一次", value: "weekly" },
          { label: "偶爾（小於一週一次）", value: "rarely" },
        ],
      },
      {
        // 3: 耳鳴3
        type: "radio",
        id: "tinnitus3",
        title: "耳鳴的聲音種類比較像什麼？",
        options: [
          { label: "高頻（蟬叫、嘰嘰叫）", value: "high" },
          { label: "低頻（轟轟叫）", value: "low" },
          { label: "都不像", value: "none" },
        ],
      },
      {
        // 4: 睡眠1
        type: "checkbox",
        id: "sleep1",
        title: "請問你有以下的睡眠困擾嗎？(可複選)",
        options: [
          { label: "難以入睡", value: "hard_to_sleep" },
          { label: "容易醒來", value: "wake_up" },
          { label: "多夢", value: "dreams" },
          { label: "以上都沒有", value: "none" },
        ],
      },
      {
        // 5: 睡眠2
        type: "slider",
        id: "sleep2",
        title: "每天平均睡幾個小時？",
        min: 2,
        max: 15,
        step: 1,
      },
      {
        // 6: 眩暈
        type: "checkbox",
        id: "dizzy1",
        title: "請問你會有下面的困擾嗎？(可複選)",
        options: [
          { label: "眩暈", value: "dizzy" },
          { label: "腳步不穩", value: "unstable" },
          { label: "跌倒", value: "fall" },
          { label: "都沒有", value: "none" },
        ],
      },
    ];

    // 年齡對應建議睡眠時數
    function getSleepNorm(ageNum) {
      if (ageNum < 1) return 12;
      if (ageNum < 3) return 11;
      if (ageNum < 6) return 10;
      if (ageNum < 13) return 9;
      if (ageNum < 19) return 8;
      return 7;
    }

    // 使用者資料
    let user = {};
    let answers = {};
    let currentStep = 0;

    function setBg() {
      const bg = document.querySelector(".cave-bg");
      bg.className = "cave-bg"; // 先移除
      if (currentStep === 0) bg.classList.add("start");
      else if (currentStep >= 1 && currentStep <= 3)
        bg.classList.add("tinnitus");
      else if (currentStep >= 4 && currentStep <= 5)
        bg.classList.add("sleep");
      else if (currentStep === 6) bg.classList.add("dizzy");
    }

    // 主渲染
    function render() {
      const content = document.getElementById("content");
      setBg();

      if (currentStep === 0) {
        // 開始頁
        const q = questions[0];
        content.innerHTML = `
          <h2 style="text-align:center;">${q.title}</h2>
          <div class="question">
            ${q.inputs
              .map(
                (input) => `
              <div style="margin: 15px 0;">
                <label style="display:block; margin-bottom:5px;">${input.label}</label>
                <input type="${input.type}" id="${input.id}" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;" required>
              </div>
            `
              )
              .join("")}
          </div>
          <div style="text-align:center; margin-top:20px;">
            <button class="btn" style="background:#b39ddb;" onclick="startQuiz()">開始測驗</button>
          </div>
        `;
      } else if (currentStep < questions.length) {
        // 題目頁
        const q = questions[currentStep];
        let optionsHtml = "";
        if (q.type === "radio") {
          optionsHtml = q.options
            .map(
              (opt) => `
              <div class="option" onclick="selectOption(${currentStep}, '${opt.value}')" id="opt_${currentStep}_${opt.value}">
                ${opt.label}
              </div>
            `
            )
            .join("");
        } else if (q.type === "checkbox") {
          optionsHtml = q.options
            .map(
              (opt) => `
              <div class="option" onclick="toggleCheckbox(${currentStep}, '${opt.value}')" id="opt_${currentStep}_${opt.value}">
                ${opt.label}
              </div>
            `
            )
            .join("");
        } else if (q.type === "slider") {
          optionsHtml = `
            <div class="slider-container">
              <input type="range" class="slider" id="slider_${currentStep}" min="${q.min}" max="${q.max}" value="${q.min}" step="${q.step}" oninput="updateSlider(${currentStep})">
              <div class="slider-value" id="slider_value_${currentStep}">${q.min} 小時</div>
            </div>
          `;
        }
        content.innerHTML = `
          <h3 style="text-align:left;">${q.title}</h3>
          <div class="options">${optionsHtml}</div>
          <div style="text-align:center; margin-top:20px;">
            ${currentStep > 1 ? `<button class="btn" onclick="prevStep()">上一題</button>` : ""}
            <button class="btn" onclick="nextStep()" id="nextBtn" disabled>下一題</button>
          </div>
        `;
        // 預設選項
        if (answers[q.id]) {
          if (q.type === "radio") {
            const radioOption = document.getElementById(
              `opt_${currentStep}_${answers[q.id]}`
            );
            if (radioOption) {
              radioOption.classList.add("selected");
            }
            document.getElementById("nextBtn").disabled = false;
          } else if (q.type === "checkbox") {
            answers[q.id].forEach((val) => {
              const checkboxOption = document.getElementById(
                `opt_${currentStep}_${val}`
              );
              if (checkboxOption) {
                checkboxOption.classList.add("selected");
              }
            });
            document.getElementById("nextBtn").disabled = false;
          } else if (q.type === "slider") {
            const slider = document.getElementById(`slider_${currentStep}`);
            const sliderValueDisplay = document.getElementById(
              `slider_value_${currentStep}`
            );
            if (slider && sliderValueDisplay) {
              slider.value = answers[q.id];
              sliderValueDisplay.textContent = answers[q.id] + " 小時";
            }
            document.getElementById("nextBtn").disabled = false;
          }
        }
      } else {
        // 結果頁
        const hasTinnitus = answers.tinnitus1 === "yes";
        const hasSleepProblem =
          answers.sleep1 && answers.sleep1.some((v) => v !== "none");
        const hasDizzy =
          answers.dizzy1 && answers.dizzy1.some((v) => v !== "none");
        // 年齡與建議睡眠時數
        const ageNum = parseInt(user.age, 10);
        const sleepNorm = getSleepNorm(ageNum);
        const sleepHours = parseInt(answers.sleep2 || 0, 10);
        // 睡眠不合格條件（修正為只有睡眠時數不足才算不合格）
        const sleepNotEnough = sleepHours < sleepNorm;
        // 角色圖索引
        const imgIndex =
          (hasTinnitus ? 4 : 0) +
          (sleepNotEnough || hasSleepProblem ? 2 : 0) +
          (hasDizzy ? 1 : 0);
        // 健康夥伴圖
        let charImg = `<img src="img/monster_${imgIndex}.jpg" alt="健康小夥伴">`;

        // 耳鳴結論
        let tinnitusResult = "";
        if (!hasTinnitus) {
          tinnitusResult = `
            <ul class="bullet-list">
              <li>恭喜您目前並沒有耳鳴的困擾</li>
              <li>建議每年追蹤一次聽力，以確保您的聽力狀況</li>
              <li>
                <a href="https://www.greattree.com.tw/stores/a2267fEF473Ecb7C" target="_blank">預約免費聽力檢查</a>
              </li>
            </ul>
          `;
        } else {
          tinnitusResult = `
            <ul class="bullet-list">
              <li>根據<a href="https://wd.vghtpe.gov.tw/ent/Fpage.action?fid=4343" target="_blank">台北榮總耳鼻喉科</a>，耳鳴個案中約有90%有聽力受損，建議至聽力中心詳細檢查</li>
              ${
                answers.tinnitus2 === "daily" || answers.tinnitus2 === "weekly"
                  ? answers.tinnitus3 === "high"
                    ? `<li>您目前有明顯的高頻耳鳴聲，可能會有高頻聽力損失的風險</li>`
                    : answers.tinnitus3 === "low"
                    ? `<li>您目前有明顯的低頻耳鳴聲，可能會有低頻聽力損失的風險</li>`
                    : ""
                  : ""
              }
              <li>
                <a href="https://www.greattree.com.tw/stores/a2267fEF473Ecb7C" target="_blank">預約免費聽力檢查</a>
              </li>
            </ul>
          `;
        }

        // 睡眠結論（修正邏輯）
        let sleepResult = "";
        if (sleepNotEnough) {
          sleepResult = `
            <ul class="bullet-list">
              <li>你的睡眠時數低於
                <a href="https://www.facebook.com/InterviewMap/posts/%E7%BE%8E%E5%9C%8B%E7%9D%A1%E7%9C%A0%E9%86%AB%E5%AD%B8%E6%9C%83aasm%E5%BB%BA%E8%AD%B0%E6%AF%8F%E5%80%8B%E5%B9%B4%E9%BD%A1%E5%B1%A4%E7%9A%84%E5%81%A5%E5%BA%B7%E7%9D%A1%E7%9C%A0%E6%99%82%E9%96%93/2871842113070905/?locale=zh_TW" target="_blank">美國睡眠醫學會</a>建議
              </li>
              <li>建議改善睡眠品質，必要時請諮詢專業醫師。</li>
              <li>
                亦可參考
                <a href="https://shop.greattree.com.tw/productlist?item1=02&item2=0297&item3=029714" target="_blank">睡眠保健食品</a>以提升睡眠品質(服用前請詢問專業藥師)
              </li>
            </ul>
          `;
        } else if (hasSleepProblem) {
          sleepResult = `
            <ul class="bullet-list">
              <li>你雖然睡眠時數足夠，但有睡眠困擾（如多夢、難以入睡等），可能影響睡眠品質</li>
              <li>建議尋求醫生協助，或服用
                <a href="https://shop.greattree.com.tw/productlist?item1=02&item2=0297&item3=029714" target="_blank">睡眠保健食品</a>以提升睡眠品質(服用前請詢問專業藥師)
              </li>
            </ul>
          `;
        } else {
          sleepResult = `
            <ul class="bullet-list">
              <li>您目前睡眠狀況良好，祝福您有美好的睡眠以及良好的生活品質！</li>
            </ul>
          `;
        }

        // 眩暈結論
        let dizzyResult = "";
        if (hasDizzy) {
          dizzyResult = `
            <ul class="bullet-list">
              <li>根據衛生署的統計，「跌倒」是65歲以上老年人事故傷害死亡的第二大原因。跌倒可能導致髖部骨折、頭部外傷、硬腦膜下出血、軟組織損傷。因此，預防跌倒對於老年人來說至關重要。</li>
              <li>眩暈是指有天旋地轉或搖晃感，是身體平衡系統失調的表現。 主要成因有:內耳問題、中樞神經系統病變、或全身性疾病等；建議就醫請醫師評估是否有需進一步治療。</li>
              <li>亦可在醫師的評估下進行
                <a href="https://www.uho.com.tw/article-61248.html" target="_blank">前庭復健</a>
              </li>
            </ul>
          `;
        } else {
          dizzyResult = `
            <ul class="bullet-list">
              <li>沒有明顯眩暈問題，請持續注意身體狀況</li>
            </ul>
          `;
        }

        // 結果頁
        content.innerHTML = `
          <h2 style="text-align:center;">${user.name} 的測驗結果</h2>
          <div class="result-grid">
            <div class="result-item" style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;">
              <div class="result-img">
                ${charImg}
              </div>
              <div class="result-img-label result-section-title" style="margin-top:12px;">你的健康小夥伴</div>
            </div>
            <div class="result-item">
              <div class="result-section-title">耳鳴<span class="emoji">👂</span></div>
              ${tinnitusResult}
            </div>
            <div class="result-item">
              <div class="result-section-title">睡眠<span class="emoji">💤</span></div>
              ${sleepResult}
              <div style="color:#4D96FF;font-weight:bold;margin-top:6px;">
                你的年齡建議每天睡眠時數：${sleepNorm} 小時
              </div>
            </div>
            <div class="result-item">
              <div class="result-section-title">眩暈<span class="emoji">🌀</span></div>
              ${dizzyResult}
            </div>
          </div>
          <hr class="result-footer-hr">
          <div class="result-footer">
            本測驗是由 <b>古富綿聽力師</b> 親自製作，為了幫助使用者提高對於耳鳴、睡眠以及眩暈的自我認知，並提供相關建議。謝謝您的使用與關注，有任何問題也歡迎寄信給1998mushroom@gmail.com與我交流共同成長。
          </div>
          <div style="text-align:center;margin-top:20px;">
            <button class="btn" style="background:#b39ddb;" onclick="restartQuiz()">再測一次</button>
          </div>
        `;
      }
    }

    // 開始測驗
    function startQuiz() {
      const name = document.getElementById("name").value;
      const age = document.getElementById("age").value;
      if (!name || !age) {
        alert("請輸入姓名與年齡");
        return;
      }
      user = { name, age };
      currentStep = 1;
      render();
    }

    function selectOption(step, value) {
      const q = questions[step];
      answers[q.id] = value;

      // 清除其他選項
      document.querySelectorAll(`.option[id^="opt_${step}_"]`).forEach((el) => {
        el.classList.remove("selected");
      });

      // 新增選擇的選項
      const selectedOption = document.getElementById(`opt_${step}_${value}`);
      if (selectedOption) {
        selectedOption.classList.add("selected");
      }

      // 啟用下一步按鈕
      const nextBtn = document.getElementById("nextBtn");
      if (nextBtn) {
        nextBtn.disabled = false;
      }

      // 如果耳鳴選項是 'no'，跳過中間步驟
      if (q.id === "tinnitus1" && value === "no") {
        currentStep = 4; // 跳過耳鳴2,3
        setTimeout(render, 300);
      }
    }

    // 複選互斥邏輯
    function toggleCheckbox(step, value) {
      const q = questions[step];
      if (!answers[q.id]) answers[q.id] = [];

      // 互斥邏輯
      if (value === "none") {
        // 選「以上都沒有」時，清空其他選項，只留 none
        answers[q.id] = ["none"];
        // 移除其他選項的選中樣式
        q.options.forEach((opt) => {
          const el = document.getElementById(`opt_${step}_${opt.value}`);
          if (el) el.classList.remove("selected");
        });
        document.getElementById(`opt_${step}_none`).classList.add("selected");
      } else {
        // 選其他選項時，移除 none
        answers[q.id] = answers[q.id].filter((v) => v !== "none");
        const idx = answers[q.id].indexOf(value);
        if (idx === -1) {
          answers[q.id].push(value);
        } else {
          answers[q.id].splice(idx, 1);
        }
        // 取消 none 的選中樣式
        const noneEl = document.getElementById(`opt_${step}_none`);
        if (noneEl) noneEl.classList.remove("selected");
      }

      // 更新選中樣式
      q.options.forEach((opt) => {
        const el = document.getElementById(`opt_${step}_${opt.value}`);
        if (el) {
          if (answers[q.id].includes(opt.value)) {
            el.classList.add("selected");
          } else {
            el.classList.remove("selected");
          }
        }
      });

      // 啟用下一步按鈕
      const nextBtn = document.getElementById("nextBtn");
      if (nextBtn) {
        nextBtn.disabled = !answers[q.id] || answers[q.id].length === 0;
      }
    }

    function updateSlider(step) {
      const q = questions[step];
      const sliderEl = document.getElementById(`slider_${step}`);
      const sliderValueEl = document.getElementById(`slider_value_${step}`);
      if (!sliderEl || !sliderValueEl) return;

      const value = sliderEl.value;
      answers[q.id] = value;
      sliderValueEl.textContent = value + " 小時";

      const nextBtn = document.getElementById("nextBtn");
      if (nextBtn) {
        nextBtn.disabled = false;
      }
    }

    // 上一題
    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        render();
      }
    }

    // 下一題
    function nextStep() {
      const q = questions[currentStep];
      if (
        !answers[q.id] ||
        (Array.isArray(answers[q.id]) && answers[q.id].length === 0)
      ) {
        alert("請選擇答案");
        return;
      }
      if (currentStep < questions.length - 1) {
        currentStep++;
        render();
      } else {
        currentStep++;
        render();
      }
    }

    // 重測一次
    function restartQuiz() {
      user = {};
      answers = {};
      currentStep = 0;
      render();
    }

    // 初始渲染
    render();
  </script>
</body>
</html>
